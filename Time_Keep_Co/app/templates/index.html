{% extends "base.html" %}

{% block content %}
<div class="row mt-5">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-body">
                <h2 class="card-title">File Comparison Tool</h2>
                <form id="upload-form" class="mt-4">
                    <div class="mb-3">
                        <label for="tar-file" class="form-label">TAR File</label>
                        <input type="file" class="form-control" id="tar-file" name="tar_file" accept=".csv" required>
                    </div>
                    <div class="mb-3">
                        <label for="ecb-file" class="form-label">ECB File</label>
                        <input type="file" class="form-control" id="ecb-file" name="ecb_file" accept=".csv" required>
                    </div>
                    <button type="submit" class="btn btn-primary" id="submit-btn">
                        <span class="spinner-border spinner-border-sm d-none" id="loading-spinner"></span>
                        Compare Files
                    </button>
                </form>
            </div>
        </div>

        <div id="results" class="mt-4">
            <div id="summary" class="alert alert-info d-none">
                <!-- Summary will be inserted here -->
            </div>
            <div class="accordion" id="discrepancyAccordion">
                <!-- Discrepancy groups will be inserted here -->
            </div>
        </div>

        <!-- Toast notification -->
        <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
            <div id="statusToast" class="toast" role="alert">
                <div class="toast-header">
                    <strong class="me-auto" id="toastTitle">Notification</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body" id="toastMessage"></div>
            </div>
        </div>
    </div>
</div>

<style>
:root {
    --dell-blue: #007DB8;
    --dell-gray: #444444;
    --dell-light-blue: #F2F7FB;
    --dell-border: #D6D6D6;
}

.card {
    border-color: var(--dell-border);
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.btn-primary {
    background-color: var(--dell-blue);
    border-color: var(--dell-blue);
}

.btn-primary:hover {
    background-color: #006699;
    border-color: #006699;
}

.discrepancy-item {
    border-left: 3px solid var(--dell-border);
    margin: 8px 0;
    padding: 12px;
    background: white;
    transition: all 0.2s ease;
}

.discrepancy-item:hover {
    border-left-color: var(--dell-blue);
    background: var(--dell-light-blue);
}

.accordion-button:not(.collapsed) {
    background-color: var(--dell-light-blue);
    color: var(--dell-blue);
}

.type-badge {
    font-size: 0.8em;
    padding: 4px 10px;
    border-radius: 4px;
    margin-right: 8px;
    background: var(--dell-light-blue);
    color: var(--dell-gray);
    border: 1px solid var(--dell-border);
}

.comparison-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
    margin-top: 10px;
}

.value-box {
    padding: 10px;
    border-radius: 4px;
    background: white;
    border: 1px solid var(--dell-border);
}

.tar-value { border-left: 3px solid #0076CE; }
.ecb-value { border-left: 3px solid #00447C; }

@media (min-width: 768px) {
    .discrepancy-item {
        display: grid;
        grid-template-columns: 250px 1fr;
        gap: 16px;
        align-items: center;
    }

    .comparison-grid {
        margin-top: 0;
    }
}

#summary {
    background: var(--dell-light-blue);
    border: 1px solid var(--dell-border);
    border-left: 4px solid var(--dell-blue);
}

.accordion-button:focus {
    border-color: var(--dell-blue);
    box-shadow: 0 0 0 0.25rem rgba(0,125,184,0.25);
}
</style>

<script>
const typeLabels = {
    'missing_from_ecb': 'Missing from ECB',
    'missing_from_tar': 'Missing from TAR',
    'charge_mismatch': 'Charge Mismatch',
    'stop_date_mismatch': 'Stop Date Mismatch',
    'new_charge_mismatch': 'New Charge Mismatch'
};

document.getElementById('upload-form').onsubmit = async (e) => {
    e.preventDefault();
    showLoading(true);

    try {
        const formData = new FormData(e.target);
        const response = await fetch('/compare', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();

        if (response.ok) {
            displayResults(data.discrepancies);
            showToast('Success', 'Files compared successfully!', 'success');
        } else {
            throw new Error(data.error || 'Failed to compare files');
        }
    } catch (error) {
        showToast('Error', error.message, 'error');
        clearResults();
    } finally {
        showLoading(false);
    }
};

function displayResults(discrepancies) {
    const resultsDiv = document.getElementById('results');
    const accordion = document.getElementById('discrepancyAccordion');
    accordion.innerHTML = '';

    // Group discrepancies by type
    const grouped = discrepancies.reduce((acc, curr) => {
        (acc[curr.type] = acc[curr.type] || []).push(curr);
        return acc;
    }, {});

    // Display summary
    displaySummary(grouped);

    // Create accordion items for each type
    Object.entries(grouped).forEach(([type, items], index) => {
        const accordionItem = createAccordionItem(type, items, index);
        accordion.appendChild(accordionItem);
    });

    resultsDiv.classList.remove('d-none');
}

function createAccordionItem(type, items, index) {
    const div = document.createElement('div');
    div.className = 'accordion-item';
    div.innerHTML = `
        <h2 class="accordion-header">
            <button class="accordion-button ${index > 0 ? 'collapsed' : ''}" type="button"
                    data-bs-toggle="collapse" data-bs-target="#collapse${index}">
                ${typeLabels[type]} (${items.length})
            </button>
        </h2>
        <div id="collapse${index}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}"
             data-bs-parent="#discrepancyAccordion">
            <div class="accordion-body">
                ${items.map(item => createDiscrepancyItem(item)).join('')}
            </div>
        </div>
    `;
    return div;
}

function createDiscrepancyItem(item) {
    return `
        <div class="discrepancy-item">
            <div class="d-flex align-items-center mb-2">
                <span class="type-badge bg-primary">${item.spa}</span>
                <span class="type-badge bg-secondary">${item.service_code}</span>
            </div>
            ${createComparisonView(item)}
        </div>
    `;
}

function showLoading(show) {
    const spinner = document.getElementById('loading-spinner');
    const submitBtn = document.getElementById('submit-btn');
    spinner.classList.toggle('d-none', !show);
    submitBtn.disabled = show;
}

function showToast(title, message, type) {
    const toast = document.getElementById('statusToast');
    const toastTitle = document.getElementById('toastTitle');
    const toastMessage = document.getElementById('toastMessage');

    toastTitle.textContent = title;
    toastMessage.textContent = message;
    toast.classList.toggle('bg-danger', type === 'error');
    toast.classList.toggle('bg-success', type === 'success');

    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
}

function displaySummary(grouped) {
    const summary = document.getElementById('summary');
    const total = Object.values(grouped).flat().length;

    const summaryHtml = `
        <h4>Summary of Discrepancies</h4>
        <ul class="list-unstyled">
            ${Object.entries(grouped).map(([type, items]) => `
                <li class="mb-1">
                    <strong>${typeLabels[type]}:</strong> ${items.length} issues
                </li>
            `).join('')}
            <li class="mt-2"><strong>Total Discrepancies:</strong> ${total}</li>
        </ul>
    `;

    summary.innerHTML = summaryHtml;
    summary.classList.remove('d-none');
}

function createComparisonView(item) {
    if (item.type.includes('missing_from')) {
        return `<div class="alert alert-warning">
            ${item.type === 'missing_from_ecb' ? 'Record exists in TAR but not in ECB' : 'Record exists in ECB but not in TAR'}
        </div>`;
    }

    return `
        <div class="comparison-grid">
            <div class="value-box tar-value">
                <small class="text-muted">TAR Value</small>
                <div class="mt-1"><strong>${item.tar_value || 'N/A'}</strong></div>
            </div>
            <div class="value-box ecb-value">
                <small class="text-muted">ECB Value</small>
                <div class="mt-1"><strong>${item.ecb_value || 'N/A'}</strong></div>
            </div>
        </div>
    `;
}

function clearResults() {
    const resultsDiv = document.getElementById('results');
    const accordion = document.getElementById('discrepancyAccordion');
    const summary = document.getElementById('summary');

    accordion.innerHTML = '';
    summary.classList.add('d-none');
    summary.innerHTML = '';
}
</script>
{% endblock %}